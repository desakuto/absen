<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Absen Desa</title>
<style>
body{font-family:Arial;padding:15px}
select,input,button{width:100%;padding:10px;margin:6px 0}
canvas{border:1px solid #000;width:100%;height:160px;touch-action:none; /* WAJIB */}
body.noscroll{overflow:hidden;position:fixed;width:100%;}

</style>
</head>
<body>

<h3>ABSEN HARIAN DESA KUTO 2026</h3>

<select id="pegawai">
  <option value="2">Kepala Desa</option>
  <option value="3">Aghastya W. – Sekretaris Desa</option>
  <option value="4">Sarjono – Kaur Keuangan</option>
  <option value="5">Adik Nur Yulianto – Kaur Perencanaan</option>
  <option value="6">Lukman Ari R. – Kaur TU & Umum</option>
  <option value="7">Dwi Sudarno – Kasi Pemerintahan</option>
  <option value="8">Muhsin Basari – Kasi Kesejahteraan</option>
  <option value="9">Arif Sulthon A. – Kasi Pelayanan</option>
  <option value="10">Agus Cristianto – Kadus Kuto</option>
  <option value="11">Kadus Plosorejo</option>
  <option value="12">Kadus Randubener</option>
  <option value="13">Mujimin – Kadus Grobogan</option>
  <option value="14">Manto – Kadus Pengin</option>
  <option value="15">Aji Wiarto – Kadus Bandungan-Kasihan</option>
</select>

<label>Jam Masuk (Otomatis)</label>
<input type="time" id="masuk">

<label>Jam Pulang</label>
<input type="time" id="pulang">

<h4>Paraf</h4>
<canvas id="sign"></canvas>
<button onclick="clearSign()">Hapus TTD</button>

<button type="button" onclick="kirim()">Kirim Absen</button>

<script>
/* ===== JAM MASUK OTOMATIS ===== */
function pad(n){return n<10?"0"+n:n;}
window.addEventListener("load",()=>{
  const now=new Date();
  document.getElementById("masuk").value =
    pad(now.getHours())+":"+pad(now.getMinutes());
});

/* ===== TTD ===== */
const canvas = document.getElementById("sign");
const ctx = canvas.getContext("2d");

let drawing = false;

// FIX ukuran canvas
function resizeCanvas(){
  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  ctx.scale(ratio, ratio);
}
resizeCanvas();

function pos(e){
  const rect = canvas.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : e;
  return {
    x: t.clientX - rect.left,
    y: t.clientY - rect.top
  };
}

// ⛔ KUNCI SCROLL
canvas.addEventListener("touchstart", e=>{
  e.preventDefault();
  document.body.classList.add("noscroll");
  drawing = true;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
},{passive:false});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
  if(!drawing) return;
  const p = pos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
},{passive:false});

canvas.addEventListener("touchend", ()=>{
  drawing = false;
  document.body.classList.remove("noscroll");
});

// mouse (PC)
canvas.addEventListener("mousedown", e=>{
  drawing = true;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
});

canvas.addEventListener("mousemove", e=>{
  if(!drawing) return;
  const p = pos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});

canvas.addEventListener("mouseup", ()=>drawing=false);

function clearSign(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ===== KIRIM ===== */
function kirim(){
  fetch("https://script.google.com/macros/s/AKfycbzCCUgQITA-1jCRyGQd2f5HUiTmQIlQnQTdD966Nk7OazlFaqgS101kmZqImfzuQ8Qk/exec",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      row:pegawai.value,
      day:new Date().getDate(),
      masuk:masuk.value,
      pulang:pulang.value,
      sign:canvas.toDataURL("image/jpeg",0.4)
    })
  })
  .then(r => r.text())
  .then(t => {
    console.log("RESP:", t); // debug iOS

    if (t.trim() === "HARI_LIBUR") {
      alert("Hari ini LIBUR, absen tidak tersedia");
      return;
    }

    if (t.trim() === "OK") {
      alert("Absen berhasil disimpan");
      clearSign();
      return;
    }

    alert("Respon tidak dikenali: " + t);
  })
  .catch(err=>{
    alert("Koneksi gagal");
    console.error(err);
  });
}
</script>

</body>
</html>






