<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Absen Desa</title>
<style>
body{font-family:Arial;padding:15px}
select,input,button{width:100%;padding:10px;margin:6px 0}
canvas{border:1px solid #000;width:100%;height:150px;touch-action: none;   /* ⬅️ PENTING */}
body.noscroll{overflow: hidden;position: fixed;width: 100%;}
</style>
</head>
<body>

<h3>ABSEN HARIAN DESA</h3>

<select id="pegawai">
  <option value="2">Kepala Desa</option>
  <option value="3">Aghastya W. – Sekretaris Desa</option>
  <option value="4">Sarjono – Kaur Keuangan</option>
  <option value="5">Adik Nur Yulianto – Kaur Perencanaan</option>
  <option value="6">Lukman Ari R. – Kaur TU & Umum</option>
  <option value="7">Dwi Sudarno – Kasi Pemerintahan</option>
  <option value="8">Muhsin Basari – Kasi Kesejahteraan</option>
  <option value="9">Arif Sulthon A. – Kasi Pelayanan</option>
  <option value="10">Agus Cristanto – Kadus Kuto</option>
  <option value="11">Kadus Plosorejo</option>
  <option value="12">Kadus Randubener</option>
  <option value="13">Mujimin – Kadus Grobogan</option>
  <option value="14">Manto – Kadus Pengin</option>
  <option value="15">Aji Wiarto – Kadus Bandungan-Kasihan</option>
</select>

<label>Jam Masuk (Otomatis)</label>
<input type="time" id="masuk">

<label>Jam Pulang</label>
<input type="time" id="pulang">

<h4>Tanda Tangan</h4>
<canvas id="sign"></canvas>
<button onclick="clearSign()">Hapus TTD</button>

<button type="button" onclick="kirim()">Kirim Absen</button>

<script>
/* ===== JAM MASUK OTOMATIS ===== */
function pad(n){return n<10?"0"+n:n;}
window.addEventListener("load",()=>{
  const now=new Date();
  document.getElementById("masuk").value =
    pad(now.getHours())+":"+pad(now.getMinutes());
});

/* ===== TTD ===== */
const canvas=document.getElementById("sign");
const ctx=canvas.getContext("2d");
let draw=false;

canvas.addEventListener("touchstart", e => {
  e.preventDefault();            // ⬅️ KUNCI SCROLL
  document.body.classList.add("noscroll");
  drawing = true;

  const t = e.touches[0];
  const r = canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(t.clientX - r.left, t.clientY - r.top);
},{ passive:false });

// GAMBAR
canvas.addEventListener("touchmove", e => {
  if (!drawing) return;
  e.preventDefault();            // ⬅️ KUNCI SCROLL

  const t = e.touches[0];
  const r = canvas.getBoundingClientRect();
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";

  ctx.lineTo(t.clientX - r.left, t.clientY - r.top);
  ctx.stroke();
},{ passive:false });

// SELESAI GAMBAR
canvas.addEventListener("touchend", e => {
  e.preventDefault();
  drawing = false;
  ctx.beginPath();
  document.body.classList.remove("noscroll");
},{ passive:false });

function clearSign(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ===== KIRIM ===== */
function kirim(){
  fetch("https://script.google.com/macros/s/AKfycbzJCY66ckrkysENPketuZdmaPhn3IuI_-mf9HsSCyiEtihTTkM1xCyHh0iZd1sEi4Hydg/exec",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      row:pegawai.value,
      day:new Date().getDate(),
      masuk:masuk.value,
      pulang:pulang.value,
      sign:canvas.toDataURL("image/jpeg",0.4)
    })
  })
  .then(r => r.text())
  .then(t => {
    console.log("RESP:", t); // debug iOS

    if (t.trim() === "HARI_LIBUR") {
      alert("Hari ini LIBUR, absen tidak tersedia");
      return;
    }

    if (t.trim() === "OK") {
      alert("Absen berhasil disimpan");
      clearSign();
      return;
    }

    alert("Respon tidak dikenali: " + t);
  })
  .catch(err=>{
    alert("Koneksi gagal");
    console.error(err);
  });
}
</script>

</body>
</html>



